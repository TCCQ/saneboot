<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<title>README.html</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>

</head>

<body>

<p>This is an attempt at a sane booting protocol for RISC-V. Specifically it targets the StarFive boards. It also supports the qemu virt machine for ease of development.</p>

<p>Be sure to have git-lfs and do a <code>git submodule update --init --recursive</code>.</p>

<p>This is an incomplete list of required build tools you might not already have, feel free to add to it:
- cpio
- dtc
- mtools</p>

<p>There are two main ways of using this system. The goal of both is to allow you to launch the binary located at <code>kernel/kernel</code> on top of an opensbi + uboot base. This means that the kernel can use opensbi calls, and uboot is just there to get the ball rolling.</p>

<ul>
<li><p>The first is to create a bootable sd card image for use with Starfive VisionFive2 boards. This can be accomplished by placing your kernel at <code>kernel/kernel</code> (or better yet, replacing the make rule for it), and running <code>make sd.img</code>. This should make a raw disk image called <code>sd.img</code> in the root of the repo that can be booted on a VF2 board after flashing the sd (likely with <code>dd</code>). Once at the uboot prompt, copy the image into memory with <code>load mmc 1:3 0x90000000 visionfive2.itb</code>, inspect it with <code>iminfo 0x90000000</code> and launch it with <code>bootm 0x90000000</code>. When in doubt, uboot has <code>help [cmd]</code>.</p></li>
<li><p>The second is to run a qemu virtual machine to quickly test a kernel build. This also uses <code>kernel/kernel</code> in the same way, and can be invoked with <code>make virt-run</code>. Once at the uboot prompt, <code>bootm 0x90000000</code> should start your kernel. You can exit with <code>C-a x</code>.</p></li>
</ul>


<p>Be sure to <code>make clean</code> between switching targets!</p>

<p>The idea is that if your kernel can be configured to expect either the virt machine or the VF2 board, then you can quickly prototype with virt, and run production with VF2.</p>

<p>U-boot should supply your kernel with a device tree on boot (passed in a register). The devices trees should be correct for the two targets above if your kernel expects/uses them.</p>

<p>An more in-depth explanation of what all the build artifacts and files are can be found in the makefile.</p>

<hr />

<ul>
<li>Sources:</li>
<li>Much of the content of this repo is stolen from the StarFive/VisionFive2 example repo&rsquo;s build procedure.</li>
<li>The device tree binary for visionfive2 is stolen from the linux build inside the starfive repo above</li>
<li>The device tree binary for virt is acquired via <code>qemu-system-riscv64 -M virt,dumpdtb=virt.dtb</code></li>
<li>The .its source files are adapted from the u-boot repo docs directory</li>
</ul>


</body>
</html>
